---
# Add a new credential to the existing encrypted vault file
# without regenerating existing passwords.
#
# Usage:
#   ansible-playbook add_vault_credential.yml \
#     -e 'credential_path=pihole.admin.password'
#
# Optionally provide a specific value (otherwise a random 32-char password is generated):
#   ansible-playbook add_vault_credential.yml \
#     -e 'credential_path=pihole.admin.password' \
#     -e 'credential_value=mysecretvalue'
#
# The credential_path is relative to the top-level "vault:" key.
# e.g. "pihole.admin.password" becomes:
#   vault:
#     pihole:
#       admin:
#         password: <value>

- name: Add credential to vault
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
    - name: Validate credential_path is provided
      ansible.builtin.assert:
        that: credential_path is defined and credential_path | length > 0
        fail_msg: >-
          Provide credential_path via -e, e.g.:
          ansible-playbook add_vault_credential.yml -e 'credential_path=pihole.admin.password'

    - name: Generate random password if value not provided
      ansible.builtin.set_fact:
        credential_value: "{{ lookup('ansible.builtin.password', '/dev/null length=32 chars=ascii_letters,digits') }}"
      when: credential_value is not defined or credential_value | length == 0
      no_log: true

    - name: Decrypt vault file
      ansible.builtin.command:
        cmd: ansible-vault decrypt vars/vault.yml --vault-password-file=./.vault/vault-pass.sh

    - name: Load existing vault variables
      ansible.builtin.include_vars:
        file: vars/vault.yml
        name: existing_vault

    - name: Build nested dict from dotted credential path
      ansible.builtin.shell: |
        python3 -c "
        import json, functools
        path = '{{ credential_path }}'.split('.')
        value = '{{ credential_value }}'
        result = functools.reduce(lambda v, k: {k: v}, reversed(path), value)
        print(json.dumps(result))
        "
      register: nested_result
      no_log: true
      changed_when: false

    - name: Merge new credential into existing vault
      ansible.builtin.set_fact:
        merged_vault: "{{ existing_vault | combine({'vault': existing_vault.vault | combine(nested_result.stdout | from_json, recursive=True)}) }}"
      no_log: true

    - name: Write merged vault file
      ansible.builtin.copy:
        content: "{{ merged_vault | to_nice_yaml(indent=2) }}"
        dest: vars/vault.yml
        mode: '0600'
      no_log: true

    - name: Re-encrypt vault file
      ansible.builtin.command:
        cmd: ansible-vault encrypt vars/vault.yml --vault-password-file=./.vault/vault-pass.sh

    - name: Credential added successfully
      ansible.builtin.debug:
        msg: "Added credential at vault.{{ credential_path }}"
