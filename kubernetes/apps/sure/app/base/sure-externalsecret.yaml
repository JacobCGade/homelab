---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: sure-postgres-externalsecret
  namespace: sure
spec:
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: sure-postgres
  data:
    - secretKey: username
      remoteRef:
        key: sure/postgres
        property: username
    - secretKey: password
      remoteRef:
        key: sure/postgres
        property: password
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: sure-redis-externalsecret
  namespace: sure
spec:
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: sure-redis
  data:
    - secretKey: password
      remoteRef:
        key: sure/redis
        property: password
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: sure-app-externalsecret
  namespace: sure
spec:
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: sure-app
    template:
      engineVersion: v2
      data:
        DATABASE_URL: "postgresql://{{ .postgres_username }}:{{ .postgres_password }}@sure-postgres:5432/sure"
        REDIS_URL: "redis://:{{ .redis_password }}@sure-redis:6379/0"
        SECRET_KEY_BASE: "{{ .secret_key_base }}"
        ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: "{{ .ar_primary_key }}"
        ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: "{{ .ar_deterministic_key }}"
        ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: "{{ .ar_derivation_salt }}"
  data:
    - secretKey: postgres_username
      remoteRef:
        key: sure/postgres
        property: username
    - secretKey: postgres_password
      remoteRef:
        key: sure/postgres
        property: password
    - secretKey: redis_password
      remoteRef:
        key: sure/redis
        property: password
    - secretKey: secret_key_base
      remoteRef:
        key: sure/app
        property: secret_key_base
    - secretKey: ar_primary_key
      remoteRef:
        key: sure/app
        property: ar_primary_key
    - secretKey: ar_deterministic_key
      remoteRef:
        key: sure/app
        property: ar_deterministic_key
    - secretKey: ar_derivation_salt
      remoteRef:
        key: sure/app
        property: ar_derivation_salt
